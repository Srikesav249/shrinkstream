<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShrinkStream Ultra | Video & Image</title>
    <script src="https://cdn.jsdelivr.net/gh/gzuidhof/coi-serviceworker@latest/coi-serviceworker.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { background: #09090b; color: #f4f4f5; font-family: 'Inter', sans-serif; }
        .glass { background: rgba(24, 24, 27, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); }
        .loader { width: 24px; height: 24px; border: 3px solid #8b5cf6; border-bottom-color: transparent; border-radius: 50%; display: inline-block; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="min-h-screen p-6 flex flex-col items-center">

    <header class="text-center mb-10">
        <h1 class="text-4xl font-black mb-2 bg-clip-text text-transparent bg-gradient-to-r from-white to-zinc-500">ShrinkStream Ultra</h1>
        <p class="text-zinc-400 text-sm">Now with Real Video Compression</p>
    </header>

    <div id="dropZone" class="glass w-full max-w-2xl p-16 rounded-3xl border-2 border-dashed border-zinc-800 text-center cursor-pointer hover:border-violet-500 transition-all">
        <p class="text-xl font-bold">Drop Image or Video</p>
        <p class="text-zinc-500 text-sm mt-2">MP4, MOV, JPG, PNG supported</p>
        <input type="file" id="fileInput" class="hidden" accept="video/*,image/*">
    </div>

    <div id="editor" class="hidden w-full max-w-4xl mt-10 grid grid-cols-1 md:grid-cols-2 gap-8">
        <div class="glass p-4 rounded-3xl">
            <div id="previewContainer" class="aspect-video bg-black rounded-2xl flex items-center justify-center overflow-hidden">
                <img id="imgPrev" class="hidden max-h-full">
                <video id="vidPrev" class="hidden max-h-full" controls></video>
            </div>
            <div class="mt-4 flex justify-between text-xs text-zinc-500">
                <span id="origSize">Original: 0MB</span>
                <span id="newSize">Result: --</span>
            </div>
        </div>

        <div class="glass p-8 rounded-3xl space-y-6">
            <div>
                <label class="block text-xs font-bold uppercase tracking-widest text-zinc-500 mb-4">Compression Strength</label>
                <input type="range" id="quality" min="1" max="100" value="50" class="w-full h-1.5 bg-zinc-800 rounded-lg appearance-none cursor-pointer accent-violet-500">
                <div class="flex justify-between text-[10px] mt-2 text-zinc-600">
                    <span>SMALLER FILE</span>
                    <span>BETTER QUALITY</span>
                </div>
            </div>

            <div id="status" class="hidden flex items-center gap-3 p-4 bg-zinc-900/50 rounded-2xl border border-white/5">
                <span class="loader"></span>
                <span id="statusLabel" class="text-sm font-medium">Processing...</span>
            </div>

            <button id="processBtn" class="w-full py-4 bg-violet-600 hover:bg-violet-500 rounded-2xl font-bold transition-all shadow-lg shadow-violet-900/20">
                Compress Now
            </button>
            
            <a id="downloadLink" class="hidden w-full py-4 bg-emerald-600 hover:bg-emerald-500 rounded-2xl font-bold text-center block transition-all">
                Download Result
            </a>
        </div>
    </div>

    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
    
    <script>
        const { createFFmpeg, fetchFile } = FFmpeg;
        const ffmpeg = createFFmpeg({ log: true });
        
        const fileInput = document.getElementById('fileInput');
        const dropZone = document.getElementById('dropZone');
        const processBtn = document.getElementById('processBtn');
        const status = document.getElementById('status');
        const downloadLink = document.getElementById('downloadLink');

        let selectedFile = null;

        dropZone.onclick = () => fileInput.click();
        fileInput.onchange = (e) => handleFile(e.target.files[0]);

        function handleFile(file) {
            if (!file) return;
            selectedFile = file;
            document.getElementById('editor').classList.remove('hidden');
            dropZone.classList.add('hidden');
            document.getElementById('origSize').innerText = `Original: ${(file.size / (1024*1024)).toFixed(2)} MB`;

            if (file.type.startsWith('video')) {
                document.getElementById('vidPrev').classList.remove('hidden');
                document.getElementById('imgPrev').classList.add('hidden');
                document.getElementById('vidPrev').src = URL.createObjectURL(file);
            } else {
                document.getElementById('imgPrev').classList.remove('hidden');
                document.getElementById('vidPrev').classList.add('hidden');
                document.getElementById('imgPrev').src = URL.createObjectURL(file);
            }
        }

        processBtn.onclick = async () => {
            if (!selectedFile) return;
            
            status.classList.remove('hidden');
            processBtn.classList.add('hidden');
            downloadLink.classList.add('hidden');

            if (selectedFile.type.startsWith('video')) {
                await compressVideo();
            } else {
                await compressImage();
            }

            status.classList.add('hidden');
            processBtn.classList.remove('hidden');
        };

        async function compressVideo() {
            document.getElementById('statusLabel').innerText = "Loading FFmpeg...";
            if (!ffmpeg.isLoaded()) await ffmpeg.load();
            
            document.getElementById('statusLabel').innerText = "Encoding Video (this may take a minute)...";
            const { name } = selectedFile;
            ffmpeg.FS('writeFile', name, await fetchFile(selectedFile));
            
            // Map quality slider (1-100) to FFmpeg CRF (51-18)
            // Lower CRF = Better quality. 18 is visually lossless, 51 is very compressed.
            const crf = Math.floor(51 - (document.getElementById('quality').value * 0.33));
            
            // Run FFmpeg command
            await ffmpeg.run('-i', name, '-vcodec', 'libx264', '-crf', crf.toString(), '-preset', 'ultrafast', 'output.mp4');
            
            const data = ffmpeg.FS('readFile', 'output.mp4');
            const blob = new Blob([data.buffer], { type: 'video/mp4' });
            finishProcess(blob, 'compressed_video.mp4');
        }

        async function compressImage() {
            document.getElementById('statusLabel').innerText = "Processing Image...";
            const img = document.getElementById('imgPrev');
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = img.naturalWidth;
            canvas.height = img.naturalHeight;
            ctx.drawImage(img, 0, 0);
            
            const quality = document.getElementById('quality').value / 100;
            canvas.toBlob((blob) => {
                finishProcess(blob, 'compressed_image.jpg');
            }, 'image/jpeg', quality);
        }

        function finishProcess(blob, filename) {
            const url = URL.createObjectURL(blob);
            downloadLink.href = url;
            downloadLink.download = filename;
            downloadLink.classList.remove('hidden');
            document.getElementById('newSize').innerText = `Result: ${(blob.size / (1024*1024)).toFixed(2)} MB`;
        }
    </script>
</body>
</html>
